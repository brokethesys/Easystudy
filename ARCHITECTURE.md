# Архитектурная документация EasyStudy

Дата: 2026-02-04

## 1. Краткое описание
EasyStudy — кроссплатформенное Flutter-приложение для обучения по билетам. Пользователь проходит уровни, отвечает на вопросы, получает опыт и валюту, открывает новые билеты и элементы кастомизации. Прогресс и настройки сохраняются локально и могут синхронизироваться через минимальный backend.

## 2. Технологический стек
- Клиент: Flutter (Dart), `provider` для управления состоянием, `shared_preferences` для локального хранилища.
- Аудио: `audioplayers`.
- Backend (опционально): FastAPI (Python), file-based хранилище конфигов пользователей.

## 3. Высокоуровневая архитектура
Архитектура состоит из 3 уровней:
1. UI слой (экраны и виджеты)
2. Слой состояния и доменной логики (`GameState`, `AccountService`)
3. Инфраструктурный слой (локальное хранилище, сеть, аудио)

UI слой подписывается на изменения `GameState` через `Provider` и реагирует на обновления. Данные читаются из локального состояния, а синхронизация с backend выполняется через `AccountService`.

## 4. Структура проекта (ключевые модули)
- `lib/main.dart` — точка входа, DI `Provider`, маршруты, темы.
- `lib/data/game_state.dart` — основное состояние игры, доменная логика, сериализация прогресса.
- `lib/data/account_service.dart` — авторизация и синхронизация конфига.
- `lib/data/backend_client.dart` — HTTP-клиент к backend API.
- `lib/audio/audio_manager.dart` — единый менеджер музыки и эффектов.
- `lib/screens/*` — экраны приложения.
- `lib/widgets/*` — общие UI-компоненты.
- `assets/questions/software_engineering.json` — банк вопросов.
- `backend/*` — минимальный API для аккаунтов и облачного конфига.

## 5. Управление состоянием
Источник истины — `GameState` (наследует `ChangeNotifier`).

Основные блоки данных:
- Общие настройки: звук, музыка, вибрация, тема, громкость.
- Профиль: ник, уровень, опыт, монеты.
- Прогресс по предметам: текущий уровень, завершенные уровни, разблокированные билеты.
- Прогресс по билетам: ответы, последний индекс, завершенность.
- Магазин: доступные и выбранные фоны/рамки/аватары.
- Достижения.

`GameState`:
- загружает состояние из `SharedPreferences` (`GameState.load()`),
- сохраняет изменения (`save()`),
- уведомляет UI (`notifyListeners()`).

## 6. Потоки данных

### 6.1 Запуск приложения
1. `main.dart` -> `GameState.load()` и `GameState.isFirstLaunch()`.
2. Создается `Provider`.
3. Рендерится `WelcomeScreen` при первом запуске, иначе `HomeScreen`.

### 6.2 Прохождение билета
1. `MapScreen` выбирает билет.
2. `QuizScreen` загружает банк вопросов из `assets/questions/...json`.
3. `SubquestionScreen` сохраняет ответы в `GameState.saveAnswer`.
4. При полном прохождении `GameState.finishTicket`:
   - помечает билет завершенным,
   - обновляет уровень,
   - разблокирует следующий билет/уровень.

### 6.3 Синхронизация с backend
1. `AccountService.register/login` получает токен.
2. При логине с конфигом `GameState.applyConfigMap` применяет данные.
3. `syncUp` отправляет локальный конфиг на сервер.
4. `syncDown` заменяет локальный конфиг серверным.

## 7. Хранилище данных

### 7.1 Локальное
`shared_preferences`:
- настройки и прогресс сохраняются по ключам в `GameState`.
- прогресс билетов сериализуется компактной строкой (`TicketProgress.serialize()`).

### 7.2 Серверное (MVP)
Backend хранит JSON-слепок конфигурации пользователя.
- пользователи: `backend/data/users.json`
- конфиги: `backend/data/configs/<user_id>.json`

## 8. Сетевое взаимодействие
`BackendClient`:
- `POST /auth/register`
- `POST /auth/login`
- `GET /config`
- `PUT /config`

Базовый URL задается через `BACKEND_URL`, дефолт: `http://10.0.2.2:8000`.

## 9. Аудио-подсистема
`AudioManager` — singleton.
- Фоновая музыка (loop).
- Звуковые эффекты: `tap`, `correct`, `wrong`, `win`, `level_up`.
- Настройки синхронизируются с `GameState`.

## 10. UI слой (экраны)
Ключевые экраны:
- `WelcomeScreen` — вступление, первый запуск.
- `HomeScreen` — центральный хаб.
- `MapScreen` — карта уровней, выбор билета.
- `QuizScreen` — прогресс и старт обучения по билету.
- `SubquestionScreen` — прохождение вопросов.
- `ShopScreen`, `AchievementsScreen`, `SettingsScreen`.

UI строится на основе `GameState` и реагирует на его изменения.

## 11. Тема и визуальная настройка
`lib/theme/app_theme.dart` задает светлую и темную тему. Текущий фон отслеживается в `ValueNotifier currentBackground` (в `main.dart`) и связан с выбранным фоном в `GameState`.

## 12. Архитектурные ограничения и риски
- Серверное хранилище file-based: подходит для MVP/тестов, не для production.
- Конфликтные изменения при sync не разрешаются (последний выиграл).
- Банк вопросов сейчас один (`software_engineering.json`); расширение потребует маршрутизации по предметам.

## 13. Направления развития
- Введение репозитория для данных (Repository layer).
- Миграция backend на DB.
- Offline-first синхронизация с конфликт-резолюцией.
- Расширение контента (несколько предметов и источников данных).
